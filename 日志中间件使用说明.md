# 日志中间件使用说明

## 功能介绍

已成功创建并注册了 `LogRequestMiddleware` 中间件，该中间件会自动记录：

### 1. 请求信息
- ✅ 请求方法（GET、POST、PUT、DELETE等）
- ✅ 完整请求URL
- ✅ 请求路由名称
- ✅ **处理的控制器和方法**（例如：UsersController@index）
- ✅ **完整的控制器类名**（例如：App\Http\Controllers\UsersController）
- ✅ 客户端IP地址
- ✅ 请求参数（自动过滤敏感信息如密码、token等）
- ✅ 请求头信息

### 2. SQL查询
- ✅ 所有SQL查询语句（增删改查）
- ✅ 查询参数自动替换（显示完整可执行的SQL）
- ✅ 每条SQL的执行时间
- ✅ SQL查询总数
- ✅ 慢查询警告（超过1秒的查询）

### 3. 性能监控
- ✅ 请求总耗时（毫秒）

## 中间件位置

- 中间件文件：`app/Http/Middleware/LogRequestMiddleware.php`
- 注册位置：`app/Http/Kernel.php` 的 `web` 中间件组

## 查看日志

### 方法1: 实时查看日志
```bash
tail -f storage/logs/laravel-$(date +%Y-%m-%d).log
```

### 方法2: 查看最近的日志
```bash
tail -100 storage/logs/laravel-$(date +%Y-%m-%d).log
```

### 方法3: 搜索特定内容
```bash
# 搜索SQL查询
grep "SQL" storage/logs/laravel-*.log

# 搜索慢查询
grep "慢查询" storage/logs/laravel-*.log

# 搜索特定URL
grep "users/index" storage/logs/laravel-*.log
```

## 日志输出示例

当你访问任何页面时，日志会记录类似以下内容：

```
================================================================================
【请求信息】
请求方法: GET
请求URL: http://127.0.0.1:8000/users
请求路由: users.index
处理器: UsersController@index
完整类名: App\Http\Controllers\UsersController
客户端IP: 127.0.0.1
请求参数: 无

【SQL查询】 共执行 1 条SQL
SQL #1 (耗时: 2.5ms):
SELECT * FROM `users` LIMIT 10 OFFSET 0

请求耗时: 45.23ms
--------------------------------------------------------------------------------
```

## 安全特性

### 自动过滤敏感信息
中间件会自动过滤以下敏感字段，不会记录实际值：
- password
- password_confirmation
- token
- secret
- api_key

这些字段在日志中会显示为：`***已过滤***`

## 性能优化建议

### 生产环境配置

如果担心日志过多影响性能，可以：

#### 1. 只在开发环境启用
修改 `app/Http/Kernel.php`：

```php
protected $middlewareGroups = [
    'web' => [
        // ... 其他中间件
        // 只在开发环境启用日志中间件
        env('APP_ENV') === 'local' ? \App\Http\Middleware\LogRequestMiddleware::class : null,
    ],
];
```

#### 2. 使用路由中间件（可选）
如果只想对特定路由启用，可以在 `Kernel.php` 中注册为命名中间件：

```php
protected $routeMiddleware = [
    // ... 其他中间件
    'log.request' => \App\Http\Middleware\LogRequestMiddleware::class,
];
```

然后在路由中使用：
```php
Route::get('/users', 'UsersController@index')->middleware('log.request');
```

## 自定义配置

### 修改慢查询阈值
在 `LogRequestMiddleware.php` 的第99行，可以修改慢查询警告的时间阈值（默认1000ms）：

```php
if ($time > 1000) { // 改为你想要的毫秒数
    Log::warning("⚠️  慢查询警告：此查询耗时超过1秒！");
}
```

### 添加更多敏感字段
在第138行的数组中添加需要过滤的字段：

```php
$sensitiveKeys = ['password', 'password_confirmation', 'token', 'secret', 'api_key', 'credit_card'];
```

### 禁用请求头记录
如果不需要记录请求头（减少日志大小），注释掉第66-70行：

```php
// 记录请求头（可选）
// $headers = $request->header();
// if (!empty($headers)) {
//     Log::info("请求头: " . json_encode($headers, JSON_UNESCAPED_UNICODE));
// }
```

## 临时禁用中间件

如果需要临时禁用中间件，在 `app/Http/Kernel.php` 中注释掉这一行：

```php
protected $middlewareGroups = [
    'web' => [
        // ... 其他中间件
        // \App\Http\Middleware\LogRequestMiddleware::class,  // 注释掉即可禁用
    ],
];
```

## 测试中间件

现在可以访问任何页面测试中间件，例如：

1. 访问用户列表页：`http://127.0.0.1:8000/users`
2. 创建新用户
3. 编辑用户信息
4. 删除用户

然后查看日志文件：
```bash
tail -100 storage/logs/laravel-$(date +%Y-%m-%d).log
```

你会看到详细的请求信息和SQL查询记录！

